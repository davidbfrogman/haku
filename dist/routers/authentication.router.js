"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const base_router_1 = require("./base/base.router");
const constants_1 = require("../constants");
const authentication_controller_1 = require("../controllers/authentication.controller");
const passport = require("passport");
const InstagramStrategy = require("passport-instagram");
const FacebookStrategy = require("passport-facebook");
const FacebookTokenStrategy = require("passport-facebook-token");
const config_1 = require("../config/config");
const enumerations_1 = require("../enumerations");
class AuthenticationRouter extends base_router_1.BaseRouter {
    constructor() {
        super();
        this.router = express_1.Router();
        this.controller = new authentication_controller_1.AuthenticationController();
        this.resource = constants_1.CONST.ep.AUTHENTICATE;
        this.initializeInstagramStrategy();
        this.initializeFacebookStrategy();
        this.initializeFacebookTokenStrategy();
    }
    initializeInstagramStrategy() {
        passport.use(new InstagramStrategy({
            clientID: config_1.Config.active.get('instagramClientId'),
            clientSecret: config_1.Config.active.get('instagramClientSecret'),
            callbackURL: `${config_1.Config.active.get('APILocation')}${constants_1.CONST.ep.API}${constants_1.CONST.ep.V1}${this.resource}${constants_1.CONST.ep.INSTAGRAM}${constants_1.CONST.ep.CALLBACK}`
        }, (accessToken, refreshToken, profile, done) => {
            // here what will come in is a profile.id
            // we need to have a controller method that will take the profile and do something with it. 
            this.controller.upsertSocialAuth(accessToken, refreshToken, profile, done, enumerations_1.LoginStrategy.Instagram, { instagramAuth: { id: profile.id } }, (profile) => {
                const user = { instagramAuth: { id: profile.id } };
                // most others will need to set the email here off the profile id.
                return user;
            });
        }));
    }
    initializeFacebookTokenStrategy() {
        passport.use(new FacebookTokenStrategy({
            clientID: config_1.Config.active.get('facebookClientId'),
            clientSecret: config_1.Config.active.get('facebookClientSecret'),
            profileFields: ['id', 'displayName', 'email',] //notice here I'm telling passport what fields I want back from facebook.
        }, (accessToken, refreshToken, profile, done) => {
            // here what will come in is a profile.id
            // we need to have a controller method that will take the profile and do something with it. 
            this.HandleFacebookStyleUpsert(accessToken, refreshToken, profile, done);
        }));
    }
    initializeFacebookStrategy() {
        passport.use(new FacebookStrategy.Strategy({
            clientID: config_1.Config.active.get('facebookClientId'),
            clientSecret: config_1.Config.active.get('facebookClientSecret'),
            callbackURL: `${config_1.Config.active.get('APILocation')}${constants_1.CONST.ep.API}${constants_1.CONST.ep.V1}${this.resource}${constants_1.CONST.ep.FACEBOOK}${constants_1.CONST.ep.CALLBACK}`,
            profileFields: ['id', 'displayName', 'email'] //notice here I'm telling passport what fields I want back from facebook.
        }, (accessToken, refreshToken, profile, done) => {
            // here what will come in is a profile.id
            // we need to have a controller method that will take the profile and do something with it. 
            this.HandleFacebookStyleUpsert(accessToken, refreshToken, profile, done);
        }));
    }
    HandleFacebookStyleUpsert(accessToken, refreshToken, profile, done) {
        this.controller.upsertSocialAuth(accessToken, refreshToken, profile, done, enumerations_1.LoginStrategy.Facebook, { facebookAuth: { id: profile.id } }, (profile) => {
            const user = { facebookAuth: { id: profile.id } };
            if (profile.emails.length > 0) {
                user.email = profile.emails[0].value;
                user.isEmailVerified = true;
            }
            // most others will need to set the email here off the profile id.
            return user;
        });
    }
    getRestrictedRouter() {
        return this.router
            .post(`${this.resource}${constants_1.CONST.ep.FACEBOOK}${constants_1.CONST.ep.CB}`, passport.authenticate('facebook', { scope: ['email'], session: false }))
            .get(`${this.resource}${constants_1.CONST.ep.FACEBOOK}${constants_1.CONST.ep.CB}${constants_1.CONST.ep.CALLBACK}`, // this uses the facebook strategy for auth.
        (request, response, next) => __awaiter(this, void 0, void 0, function* () {
            // Successful authentication, redirect home.
            yield this.controller.sendTokenResponse(request, response, next);
        }))
            .post(`${this.resource}${constants_1.CONST.ep.FACEBOOK}`, passport.authenticate('facebook-token', { scope: ['email'], session: false }), (request, response, next) => __awaiter(this, void 0, void 0, function* () {
            // Successful authentication, redirect home.
            yield this.controller.sendTokenResponse(request, response, next);
        }))
            .post(`${this.resource}${constants_1.CONST.ep.INSTAGRAM}`, passport.authenticate('instagram'))
            .get(`${this.resource}${constants_1.CONST.ep.INSTAGRAM}${constants_1.CONST.ep.CALLBACK}`, // this gets hit in the callback.
        passport.authenticate('instagram', { failureRedirect: '/', session: false }), // this uses the instagram strategy for auth.
        (request, response, next) => __awaiter(this, void 0, void 0, function* () {
            // Successful authentication, redirect home.
            yield this.controller.sendTokenResponse(request, response, next);
        }))
            .post(`${this.resource}${constants_1.CONST.ep.LOCAL}${constants_1.CONST.ep.LOGIN}`, (request, response, next) => __awaiter(this, void 0, void 0, function* () {
            yield this.controller.authenticateLocal(request, response, next);
        }))
            .post(`${this.resource}${constants_1.CONST.ep.LOCAL}${constants_1.CONST.ep.REGISTER}`, (request, response, next) => __awaiter(this, void 0, void 0, function* () {
            yield this.controller.register(request, response, next);
        }));
    }
}
exports.AuthenticationRouter = AuthenticationRouter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZlYnJvd24vRG9jdW1lbnRzL2hha3Uvc2VydmVyL3JvdXRlcnMvYXV0aGVudGljYXRpb24ucm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxxQ0FBaUM7QUFJakMsb0RBQWdEO0FBQ2hELDRDQUFxQztBQUNyQyx3RkFBb0Y7QUFDcEYscUNBQXFDO0FBQ3JDLHdEQUF3RDtBQUN4RCxzREFBc0Q7QUFDdEQsaUVBQWlFO0FBQ2pFLDZDQUEwQztBQUUxQyxrREFBZ0Q7QUFFaEQsMEJBQWtDLFNBQVEsd0JBQVU7SUFNaEQ7UUFDSSxLQUFLLEVBQUUsQ0FBQztRQUxMLFdBQU0sR0FBVyxnQkFBTSxFQUFFLENBQUM7UUFDMUIsZUFBVSxHQUFHLElBQUksb0RBQXdCLEVBQUUsQ0FBQztRQUM1QyxhQUFRLEdBQVcsaUJBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDO1FBSzVDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQywrQkFBK0IsRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFTSwyQkFBMkI7UUFDOUIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLGlCQUFpQixDQUFDO1lBQy9CLFFBQVEsRUFBRSxlQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztZQUNoRCxZQUFZLEVBQUUsZUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUM7WUFDeEQsV0FBVyxFQUFFLEdBQUcsZUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsaUJBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLGlCQUFLLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLGlCQUFLLENBQUMsRUFBRSxDQUFDLFNBQVMsR0FBRyxpQkFBSyxDQUFDLEVB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RUFBRSxRQUFrQixFQUFFLElBQWtCLEVBQUUsRUFBRTtZQUMvRCxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyRSxDQUFDLENBQUEsQ0FBQzthQUVMLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLEdBQUcsaUJBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLGlCQUFLLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQU8sT0FBZ0IsRUFBRSxRQUFrQixFQUFFLElBQWtCLEVBQUUsRUFBRTtZQUM5SCxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFBLENBQUMsQ0FBQztJQUNYLENBQUM7Q0FDSjtBQW5IRCxvREFtSEMiLCJmaWxlIjoicm91dGVycy9hdXRoZW50aWNhdGlvbi5yb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEJ1Y2tldEl0ZW1Db250cm9sbGVyIH0gZnJvbSAnLi4vY29udHJvbGxlcnMvJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBSZXF1ZXN0SGFuZGxlciwgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFJlcXVlc3RIYW5kbGVyUGFyYW1zLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzLXNlcnZlLXN0YXRpYy1jb3JlJztcbmltcG9ydCB7IEJhc2VSb3V0ZXIgfSBmcm9tICcuL2Jhc2UvYmFzZS5yb3V0ZXInO1xuaW1wb3J0IHsgQ09OU1QgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgQXV0aGVudGljYXRpb25Db250cm9sbGVyIH0gZnJvbSAnLi4vY29udHJvbGxlcnMvYXV0aGVudGljYXRpb24uY29udHJvbGxlcic7XG5pbXBvcnQgKiBhcyBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XG5pbXBvcnQgKiBhcyBJbnN0YWdyYW1TdHJhdGVneSBmcm9tICdwYXNzcG9ydC1pbnN0YWdyYW0nO1xuaW1wb3J0ICogYXMgRmFjZWJvb2tTdHJhdGVneSBmcm9tICdwYXNzcG9ydC1mYWNlYm9vayc7XG5pbXBvcnQgKiBhcyBGYWNlYm9va1Rva2VuU3RyYXRlZ3kgZnJvbSAncGFzc3BvcnQtZmFjZWJvb2stdG9rZW4nO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2NvbmZpZyc7XG5pbXBvcnQgeyBJVXNlciB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBMb2dpblN0cmF0ZWd5IH0gZnJvbSAnLi4vZW51bWVyYXRpb25zJztcblxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0aW9uUm91dGVyIGV4dGVuZHMgQmFzZVJvdXRlciB7XG5cbiAgICBwdWJsaWMgcm91dGVyOiBSb3V0ZXIgPSBSb3V0ZXIoKTtcbiAgICBwdWJsaWMgY29udHJvbGxlciA9IG5ldyBBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXIoKTtcbiAgICBwdWJsaWMgcmVzb3VyY2U6IHN0cmluZyA9IENPTlNULmVwLkFVVEhFTlRJQ0FURTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLmluaXRpYWxpemVJbnN0YWdyYW1TdHJhdGVneSgpO1xuICAgICAgICB0aGlzLmluaXRpYWxpemVGYWNlYm9va1N0cmF0ZWd5KCk7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZUZhY2Vib29rVG9rZW5TdHJhdGVneSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbml0aWFsaXplSW5zdGFncmFtU3RyYXRlZ3koKSB7XG4gICAgICAgIHBhc3Nwb3J0LnVzZShuZXcgSW5zdGFncmFtU3RyYXRlZ3koe1xuICAgICAgICAgICAgY2xpZW50SUQ6IENvbmZpZy5hY3RpdmUuZ2V0KCdpbnN0YWdyYW1DbGllbnRJZCcpLFxuICAgICAgICAgICAgY2xpZW50U2VjcmV0OiBDb25maWcuYWN0aXZlLmdldCgnaW5zdGFncmFtQ2xpZW50U2VjcmV0JyksXG4gICAgICAgICAgICBjYWxsYmFja1VSTDogYCR7Q29uZmlnLmFjdGl2ZS5nZXQoJ0FQSUxvY2F0aW9uJyl9JHtDT05TVC5lcC5BUEl9JHtDT05TVC5lcC5WMX0ke3RoaXMucmVzb3VyY2V9JHtDT05TVC5lcC5JTlNUQUdSQU19JHtDT05TVC5lcC5DQUxMQkFDS31gXG4gICAgICAgIH0sXG4gICAgICAgICAgICAoYWNjZXNzVG9rZW4sIHJlZnJlc2hUb2tlbiwgcHJvZmlsZSwgZG9uZSkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGhlcmUgd2hhdCB3aWxsIGNvbWUgaW4gaXMgYSBwcm9maWxlLmlkXG4gICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBoYXZlIGEgY29udHJvbGxlciBtZXRob2QgdGhhdCB3aWxsIHRha2UgdGhlIHByb2ZpbGUgYW5kIGRvIHNvbWV0aGluZyB3aXRoIGl0LiBcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIudXBzZXJ0U29jaWFsQXV0aChhY2Nlc3NUb2tlbiwgcmVmcmVzaFRva2VuLCBwcm9maWxlLCBkb25lLCBMb2dpblN0cmF0ZWd5Lkluc3RhZ3JhbSwgeyBpbnN0YWdyYW1BdXRoOiB7IGlkOiBwcm9maWxlLmlkIH0gfSwgKHByb2ZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlcjogSVVzZXIgPSB7IGluc3RhZ3JhbUF1dGg6IHsgaWQ6IHByb2ZpbGUuaWQgfSB9XG4gICAgICAgICAgICAgICAgICAgIC8vIG1vc3Qgb3RoZXJzIHdpbGwgbmVlZCB0byBzZXQgdGhlIGVtYWlsIGhlcmUgb2ZmIHRoZSBwcm9maWxlIGlkLlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXNlcjtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICApKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5pdGlhbGl6ZUZhY2Vib29rVG9rZW5TdHJhdGVneSgpOiBhbnkge1xuICAgICAgICBwYXNzcG9ydC51c2UobmV3IEZhY2Vib29rVG9rZW5TdHJhdGVneSh7XG4gICAgICAgICAgICBjbGllbnRJRDogQ29uZmlnLmFjdGl2ZS5nZXQoJ2ZhY2Vib29rQ2xpZW50SWQnKSxcbiAgICAgICAgICAgIGNsaWVudFNlY3JldDogQ29uZmlnLmFjdGl2ZS5nZXQoJ2ZhY2Vib29rQ2xpZW50U2VjcmV0JyksXG4gICAgICAgICAgICBwcm9maWxlRmllbGRzOiBbJ2lkJywgJ2Rpc3BsYXlOYW1lJywgJ2VtYWlsJyxdIC8vbm90aWNlIGhlcmUgSSdtIHRlbGxpbmcgcGFzc3BvcnQgd2hhdCBmaWVsZHMgSSB3YW50IGJhY2sgZnJvbSBmYWNlYm9vay5cbiAgICAgICAgfSxcbiAgICAgICAgICAgIChhY2Nlc3NUb2tlbiwgcmVmcmVzaFRva2VuLCBwcm9maWxlLCBkb25lKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gaGVyZSB3aGF0IHdpbGwgY29tZSBpbiBpcyBhIHByb2ZpbGUuaWRcbiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGhhdmUgYSBjb250cm9sbGVyIG1ldGhvZCB0aGF0IHdpbGwgdGFrZSB0aGUgcHJvZmlsZSBhbmQgZG8gc29tZXRoaW5nIHdpdGggaXQuIFxuICAgICAgICAgICAgICAgIHRoaXMuSGFuZGxlRmFjZWJvb2tTdHlsZVVwc2VydChhY2Nlc3NUb2tlbixyZWZyZXNoVG9rZW4scHJvZmlsZSxkb25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGluaXRpYWxpemVGYWNlYm9va1N0cmF0ZWd5KCkge1xuICAgICAgICBwYXNzcG9ydC51c2UobmV3IEZhY2Vib29rU3RyYXRlZ3kuU3RyYXRlZ3koe1xuICAgICAgICAgICAgY2xpZW50SUQ6IENvbmZpZy5hY3RpdmUuZ2V0KCdmYWNlYm9va0NsaWVudElkJyksXG4gICAgICAgICAgICBjbGllbnRTZWNyZXQ6IENvbmZpZy5hY3RpdmUuZ2V0KCdmYWNlYm9va0NsaWVudFNlY3JldCcpLFxuICAgICAgICAgICAgY2FsbGJhY2tVUkw6IGAke0NvbmZpZy5hY3RpdmUuZ2V0KCdBUElMb2NhdGlvbicpfSR7Q09OU1QuZXAuQVBJfSR7Q09OU1QuZXAuVjF9JHt0aGlzLnJlc291cmNlfSR7Q09OU1QuZXAuRkFDRUJPT0t9JHtDT05TVC5lcC5DQUxMQkFDS31gLFxuICAgICAgICAgICAgcHJvZmlsZUZpZWxkczogWydpZCcsICdkaXNwbGF5TmFtZScsICdlbWFpbCddIC8vbm90aWNlIGhlcmUgSSdtIHRlbGxpbmcgcGFzc3BvcnQgd2hhdCBmaWVsZHMgSSB3YW50IGJhY2sgZnJvbSBmYWNlYm9vay5cbiAgICAgICAgfSxcbiAgICAgICAgICAgIChhY2Nlc3NUb2tlbiwgcmVmcmVzaFRva2VuLCBwcm9maWxlLCBkb25lKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gaGVyZSB3aGF0IHdpbGwgY29tZSBpbiBpcyBhIHByb2ZpbGUuaWRcbiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGhhdmUgYSBjb250cm9sbGVyIG1ldGhvZCB0aGF0IHdpbGwgdGFrZSB0aGUgcHJvZmlsZSBhbmQgZG8gc29tZXRoaW5nIHdpdGggaXQuIFxuICAgICAgICAgICAgICAgIHRoaXMuSGFuZGxlRmFjZWJvb2tTdHlsZVVwc2VydChhY2Nlc3NUb2tlbixyZWZyZXNoVG9rZW4scHJvZmlsZSxkb25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBIYW5kbGVGYWNlYm9va1N0eWxlVXBzZXJ0KGFjY2Vzc1Rva2VuLCByZWZyZXNoVG9rZW4sIHByb2ZpbGUsIGRvbmUpe1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXIudXBzZXJ0U29jaWFsQXV0aChhY2Nlc3NUb2tlbiwgcmVmcmVzaFRva2VuLCBwcm9maWxlLCBkb25lLCBMb2dpblN0cmF0ZWd5LkZhY2Vib29rLCB7IGZhY2Vib29rQXV0aDogeyBpZDogcHJvZmlsZS5pZCB9IH0sIChwcm9maWxlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB1c2VyOiBJVXNlciA9IHsgZmFjZWJvb2tBdXRoOiB7IGlkOiBwcm9maWxlLmlkIH0gfVxuICAgICAgICAgICAgaWYocHJvZmlsZS5lbWFpbHMubGVuZ3RoID4gMCl7XG4gICAgICAgICAgICAgICAgdXNlci5lbWFpbCA9IHByb2ZpbGUuZW1haWxzWzBdLnZhbHVlO1xuICAgICAgICAgICAgICAgIHVzZXIuaXNFbWFpbFZlcmlmaWVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIG1vc3Qgb3RoZXJzIHdpbGwgbmVlZCB0byBzZXQgdGhlIGVtYWlsIGhlcmUgb2ZmIHRoZSBwcm9maWxlIGlkLlxuICAgICAgICAgICAgcmV0dXJuIHVzZXI7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSZXN0cmljdGVkUm91dGVyKCk6IFJvdXRlciB7XG4gICAgICAgIHJldHVybiB0aGlzLnJvdXRlclxuICAgICAgICAgICAgLy8gQWxsIHRoZSByb3V0ZXMgZm9yIGluc3RhZ3JhbSBhdXRoZW50aWNhdGlvbi5cbiAgICAgICAgICAgIC8vIHRvIHRlc3QgdGhlc2Ugcm91dGVzIGhpdCB0aGlzIFVSTCA9PiBodHRwOi8vbG9jYWxob3N0OjkwMDAvYXBpL3YxL2F1dGhlbnRpY2F0ZS9mYWNlYm9va1xuICAgICAgICAgICAgLy8gdGhhdCBzaG91bGQgYXV0aCB0aHJvdWdoIGluc3RhZ3JhbSwgYW5kIGNvbWUgYmFjayB0byB0aGUgY2FsbGJhY2suIFxuICAgICAgICAgICAgLy8nZmFjZWJvb2stdG9rZW4nXG4gICAgICAgICAgICAucG9zdChgJHt0aGlzLnJlc291cmNlfSR7Q09OU1QuZXAuRkFDRUJPT0t9JHtDT05TVC5lcC5DQn1gLCBwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ2ZhY2Vib29rJywgeyBzY29wZTogWydlbWFpbCddLCBzZXNzaW9uOiBmYWxzZSB9KSlcbiAgICAgICAgICAgIC5nZXQoYCR7dGhpcy5yZXNvdXJjZX0ke0NPTlNULmVwLkZBQ0VCT09LfSR7Q09OU1QuZXAuQ0J9JHtDT05TVC5lcC5DQUxMQkFDS31gLCAgLy8gdGhpcyB1c2VzIHRoZSBmYWNlYm9vayBzdHJhdGVneSBmb3IgYXV0aC5cbiAgICAgICAgICAgICAgICBhc3luYyAocmVxdWVzdDogUmVxdWVzdCwgcmVzcG9uc2U6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU3VjY2Vzc2Z1bCBhdXRoZW50aWNhdGlvbiwgcmVkaXJlY3QgaG9tZS5cbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jb250cm9sbGVyLnNlbmRUb2tlblJlc3BvbnNlKHJlcXVlc3QsIHJlc3BvbnNlLCBuZXh0KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLydmYWNlYm9vay10b2tlbicgLSBUaGVyZSdzIG5vIGNhbGxiYWNrIHdpdGggdGhpcyBzdHJhdGVneS4gIEl0J3MgYmFzaWNhbGx5IGp1c3Qgc2VuZGluZyB1cCBhIHNob3J0IHRpbWUgdG9rZW5cbiAgICAgICAgICAgIC8vIGFuZCB0aGVuIHdlIHNlbmQgZG93biBhIGxvbmcgdGVybSB0b2tlbi5cbiAgICAgICAgICAgIC5wb3N0KGAke3RoaXMucmVzb3VyY2V9JHtDT05TVC5lcC5GQUNFQk9PS31gLCBwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ2ZhY2Vib29rLXRva2VuJywgeyBzY29wZTogWydlbWFpbCddLCBzZXNzaW9uOiBmYWxzZSB9KSxcbiAgICAgICAgICAgIGFzeW5jIChyZXF1ZXN0OiBSZXF1ZXN0LCByZXNwb25zZTogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3NmdWwgYXV0aGVudGljYXRpb24sIHJlZGlyZWN0IGhvbWUuXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jb250cm9sbGVyLnNlbmRUb2tlblJlc3BvbnNlKHJlcXVlc3QsIHJlc3BvbnNlLCBuZXh0KTtcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIC8vIEFsbCB0aGUgcm91dGVzIGZvciBpbnN0YWdyYW0gYXV0aGVudGljYXRpb24uXG4gICAgICAgICAgICAvLyB0byB0ZXN0IHRoZXNlIHJvdXRlcyBoaXQgdGhpcyBVUkwgPT4gaHR0cDovL2xvY2FsaG9zdDo5MDAwL2FwaS92MS9hdXRoZW50aWNhdGUvaW5zdGFncmFtL1xuICAgICAgICAgICAgLy8gdGhhdCBzaG91bGQgYXV0aCB0aHJvdWdoIGluc3RhZ3JhbSwgYW5kIGNvbWUgYmFjayB0byB0aGUgY2FsbGJhY2suIFxuICAgICAgICAgICAgLnBvc3QoYCR7dGhpcy5yZXNvdXJjZX0ke0NPTlNULmVwLklOU1RBR1JBTX1gLCBwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ2luc3RhZ3JhbScpKVxuICAgICAgICAgICAgLmdldChgJHt0aGlzLnJlc291cmNlfSR7Q09OU1QuZXAuSU5TVEFHUkFNfSR7Q09OU1QuZXAuQ0FMTEJBQ0t9YCwgLy8gdGhpcyBnZXRzIGhpdCBpbiB0aGUgY2FsbGJhY2suXG4gICAgICAgICAgICAgICAgcGFzc3BvcnQuYXV0aGVudGljYXRlKCdpbnN0YWdyYW0nLCB7IGZhaWx1cmVSZWRpcmVjdDogJy8nLCBzZXNzaW9uOiBmYWxzZSB9KSwgLy8gdGhpcyB1c2VzIHRoZSBpbnN0YWdyYW0gc3RyYXRlZ3kgZm9yIGF1dGguXG4gICAgICAgICAgICAgICAgYXN5bmMgKHJlcXVlc3Q6IFJlcXVlc3QsIHJlc3BvbnNlOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3NmdWwgYXV0aGVudGljYXRpb24sIHJlZGlyZWN0IGhvbWUuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY29udHJvbGxlci5zZW5kVG9rZW5SZXNwb25zZShyZXF1ZXN0LCByZXNwb25zZSwgbmV4dCk7XG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgLy8gVGhpcyBpcyBmb3IgdGhlIGxvY2FsIGxvZ2luIHNjaGVtZXMuXG4gICAgICAgICAgICAucG9zdChgJHt0aGlzLnJlc291cmNlfSR7Q09OU1QuZXAuTE9DQUx9JHtDT05TVC5lcC5MT0dJTn1gLFxuICAgICAgICAgICAgICAgIGFzeW5jIChyZXF1ZXN0OiBSZXF1ZXN0LCByZXNwb25zZTogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNvbnRyb2xsZXIuYXV0aGVudGljYXRlTG9jYWwocmVxdWVzdCwgcmVzcG9uc2UsIG5leHQpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAvLyBUaGlzIGlzIGZvciByZWdpc3RlcmluZyBhIG5ldyB1c2VyIHdpdGggYSBsb2NhbCBzY2hlbWUuXG4gICAgICAgICAgICAucG9zdChgJHt0aGlzLnJlc291cmNlfSR7Q09OU1QuZXAuTE9DQUx9JHtDT05TVC5lcC5SRUdJU1RFUn1gLCBhc3luYyAocmVxdWVzdDogUmVxdWVzdCwgcmVzcG9uc2U6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNvbnRyb2xsZXIucmVnaXN0ZXIocmVxdWVzdCwgcmVzcG9uc2UsIG5leHQpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==
